---
# Example: Nginx Reverse Proxy with SSL
# Generated by Ansible MCP Server

- name: Configure Nginx as Reverse Proxy
  hosts: "{{ target_hosts | default('webservers') }}"
  become: yes
  vars:
    nginx_worker_processes: auto
    nginx_worker_connections: 1024
    backend_host: "{{ backend | default('localhost') }}"
    backend_port: "{{ backend_port | default('8080') }}"
    server_name: "{{ domain | default('example.com') }}"
    ssl_certificate: "/etc/ssl/certs/{{ server_name }}.crt"
    ssl_certificate_key: "/etc/ssl/private/{{ server_name }}.key"

  tasks:
    - name: Install Nginx
      package:
        name: nginx
        state: present
      tags:
        - install
        - nginx

    - name: Create SSL directory
      file:
        path: /etc/ssl/private
        state: directory
        mode: '0700'
      tags:
        - ssl
        - nginx

    - name: Configure Nginx
      template:
        src: nginx.conf.j2
        dest: /etc/nginx/sites-available/{{ server_name }}
        mode: '0644'
      notify: reload nginx
      tags:
        - configure
        - nginx

    - name: Enable site
      file:
        src: /etc/nginx/sites-available/{{ server_name }}
        dest: /etc/nginx/sites-enabled/{{ server_name }}
        state: link
      notify: reload nginx
      tags:
        - configure
        - nginx

    - name: Remove default site
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: reload nginx
      tags:
        - configure
        - nginx

    - name: Start Nginx
      service:
        name: nginx
        state: started
        enabled: yes
      tags:
        - service
        - nginx

    - name: Configure firewall for HTTP/HTTPS
      ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
      loop:
        - '80'
        - '443'
      when: ansible_facts['os_family'] == 'Debian'
      tags:
        - firewall
        - security

  handlers:
    - name: reload nginx
      service:
        name: nginx
        state: reloaded
